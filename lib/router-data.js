import axios from"axios";let getToken="",url="";const urldev="http://10.0.10.213:8200",urlProd="http://10.0.10.213:8200";let routerMaps=[],originalData=[],menuList=[],controlDataTagList={};function routerData({token:e,platform_key:r,routerUrl:a,dataType:n=1,env:o="dev"}){return new Promise(t=>{if(!e)return{errno:1,errmsg:"token参数错误"};getToken=e,url="dev"===o?urldev:urlProd,routerMaps=a,getMenuDataAndTag({platform_key:r}).then(e=>{switch(menuList=e.menuData,controlDataTagList=e.tagData,console.log(1231,e),n){case 1:case"1":return void t(menuList);case 2:case"2":return void t(controlDataTagList);default:return void t({menuList:menuList,controlDataTagList:controlDataTagList})}})})}axios.interceptors.response.use(e=>{return e.data},async e=>{const t={errno:-1,errmsg:""};return e.response?401===e.response.status?t.errmsg="登录信息过期，跳转登录页401":t.errmsg="错误状态码："+e.response.status:t.errmsg=e.config.url+"响应失败，请刷新浏览器重试。原因"+e,Promise.reject(t)});const getMenuDataAndTag=e=>new Promise(r=>{axios.defaults.headers.common["x-xq5-jwt"]=getToken,axios.get(url+"/v1/web/menu",{params:e}).then(e=>{var t;e&&e.data&&0===Number(e.errno)&&(e=generateAsyncRouter(originalData=e.data||[],1),t=generateAsyncRouter(originalData,2),r({menuData:e,tagData:t}))})});function generateAsyncRouter(e,a=1,n=!1){const o=[];switch(a){case 1:case"1":return e.forEach(e=>{var t=e.children&&0<e.children.length;const r=generateRouter(e,!n||t,n);t&&e.children&&0!==e.children.filter(e=>2===e.type).length?r.children=generateAsyncRouter(e.children,a,!0)||[]:n||(r.children=generateRouter(e,t,n)),1!==Number(e.type)&&2!==Number(e.type)||1!==Number(e.status)||o.push(r)}),o;case 2:case"2":return generateControlAndDataTag(e);default:return[]}}const generateRouter=(e,t,r)=>({path:e.is_out_link?e.route_data:t?"/"+e.route_data:e.route_data||"",name:e.is_out_link||t?e.route_data:e.route_data||"",meta:{title:e.name,icon:e.icon,id:e.menu_id,newTime:10<=e.showtime.length?dateAndTimestampConversion(e.showtime):"",noCache:!1},component:e.is_out_link?e.route_data:t&&!r?routerMaps.Layout:routerMaps[e.route_data]||""});function dateAndTimestampConversion(e,t=!0){var r=Object.prototype.toString.call(e);if("[object Number]"!==r&&"[object String]"!==r)throw new Error("参数应为数字或字符串类型");var r="[object Number]"===r;if(r&&10!==String(e).length&&13!==String(e).length)throw new Error("时间戳位数应为10位数或13位数");if(!r&&10!==e.length&&19!==e.length)throw new Error("日期位数应为10位数或19位数");if(String(e).includes("-")||String(e).includes("/"))return r=e.replace(/-/g,"/"),new Date(r).getTime();{const s=new Date(10===String(e).length?1e3*Number(e):Number(e));var r=s.getFullYear(),e=(s.getMonth()+1).toString().padStart(2,"0"),a=s.getDate().toString().padStart(2,"0"),n=s.getHours().toString().padStart(2,"0"),o=s.getMinutes().toString().padStart(2,"0"),u=s.getSeconds().toString().padStart(2,"0");return t?r+`-${e}-`+a:r+`-${e}-${a} ${n}:${o}:`+u}}const getSubPlatformData=e=>{axios.defaults.headers.common["x-xq5-jwt"]=getToken,axios.get(url+"/v1/web/sub_platform",{params:e}).then(e=>{e&&e.data&&0===Number(e.errno)&&(console.log(2222,e),e=generateAsyncRouter(originalData=e.data||[]),console.log(111,e))})},generateControlAndDataTag=(n,o="",u={})=>(n.forEach(e=>{var t,r=e.children&&0<e.children.length,a=o;1!==Number(e.type)&&2!==Number(e.type)&&1===Number(e.status)?(t=dataControlAndDataTag(n),u[o]=t):1!==Number(e.type)&&2!==Number(e.type)||1!==Number(e.status)||(a+=e.is_out_link?e.route_data:"/"+e.route_data,r&&generateControlAndDataTag(e.children,a,u))}),u);function dataControlAndDataTag(e){const r=[];return e.forEach(e=>{let t={};3===Number(e.type)||4===Number(e.type)?t={name:e.name,icon:e.icon,type:e.type,route_data:e.route_data}:5!==Number(e.type)&&6!==Number(e.type)||(t={name:e.name,backend_api:e.backend_api,type:e.type,data_labels:e.data_labels,backend_api_method:e.backend_api_method,route_data:e.route_data}),e.children&&(t.children=dataControlAndDataTag(e.children)),r.push(t)}),r}export{routerData};